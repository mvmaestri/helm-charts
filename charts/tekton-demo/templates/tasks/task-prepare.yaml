apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: prepare
  namespace: {{ .Values.application.environments.cicd }}
spec:
  workspaces:
  - name: shared
  steps:
    - name: helm
      image: registry.redhat.io/rhel8/nodejs-12
      workingDir: /workspace/shared
      script: |
        #!/bin/sh
        nexus=https://nexus-labs-ci-cd.apps.s45.core.rht-labs.com/repository/labs-static
        if curl --output /dev/null --silent --head --fail "$nexus/helm"; then
          echo "Downloading helm from nexus"
          wget -q -O helm $nexus/helm
          chmod +x helm
        else
          echo "Downloading helm"
          curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3
          chmod 700 get_helm.sh
          ./get_helm.sh
          cp /usr/local/bin/helm helm
          curl -u admin:admin123 --upload-file helm $nexus/helm
        fi
      securityContext:
        runAsUser: 0